<html><head><title>G2</title>
<script src="three.js"></script>
<script src="PuzzleGeometry.js"></script>
<script>
function parseDesc(s) {
   var a = s.split(/ /).filter(Boolean) ;
   if (a.length % 2 == 0)
      return false ;
   if (a[0] != 'o' && a[0] != 'c' && a[0] != 'i' && a[0] != 'd' && a[0] != 't')
      return false ;
   var r = [] ;
   for (var i=1; i<a.length; i += 2) {
      if (a[i] != 'f' && a[i] != 'v' && a[i] != 'e')
         return false ;
      r.push([a[i], a[i+1]]) ;
   }
   return [a[0], r] ;
}
var myfaces = null ;

// rendering code

var renderer = null, scene = null, camera = null, obj = null ;
var duration = 100000 ;
var currentTime = Date.now() ;
function animate() {
   var now = Date.now() ;
   var deltat = now - currentTime ;
   currentTime = now ;
   var fract = deltat / duration ;
   var angle = Math.PI * 2 * fract ;
   obj.rotation.y += angle;
}
var lastval ;
var textinput ;
function checkchange() {
   var s = textinput.value ;
   if (s == lastval)
      return ;
   lastval = s ;
   var p = parseDesc(s) ;
   if (p) {
      var pg = new PuzzleGeometry(p[0], p[1]) ;
      pg.allstickers() ;
      myfaces = pg.getfaces() ;
      display() ;
   }
}
function run() {
   checkchange(textinput) ;
   requestAnimationFrame(function() { run(); });
   renderer.render(scene, camera) ;
   animate() ;
}
function display() {
   var canvas = document.getElementById("webglcanvas") ;
   renderer = new THREE.WebGLRenderer({canvas:canvas, antialias:true}) ;
   renderer.setSize(canvas.width, canvas.height) ;
   scene = new THREE.Scene() ;
   camera =
         new THREE.PerspectiveCamera(45, canvas.width/canvas.height, 1, 4000) ;
   scene.add(camera) ;
   var map = {vertexColors: THREE.VertexColors} ;
// var material = new THREE.MeshPhongMaterial(map) ;
   var material = new THREE.MeshBasicMaterial(map) ;
   var geometry = new THREE.Geometry() ;
   for (var f=0; f<myfaces.length; f++) {
      var c = new THREE.Color(Math.random(), Math.random(), Math.random()) ;
      for (var g=0; g<myfaces[f].length; g++) {
         var v =
      new THREE.Vector3(myfaces[f][g][0], myfaces[f][g][1], myfaces[f][g][2]) ;
         myfaces[f][g] = geometry.vertices.length  ;
         geometry.vertices.push(v) ;
      }
      for (var g=1; g+1<myfaces[f].length; g++) {
         var face =
                new THREE.Face3(myfaces[f][0], myfaces[f][g], myfaces[f][g+1]) ;
         face.vertexColors[0] = c ;
         face.vertexColors[1] = c ;
         face.vertexColors[2] = c ;
         geometry.faces.push(face) ;
      }
   }
   geometry.computeFaceNormals() ;
   obj = new THREE.Mesh(geometry, material) ;
   obj.position.z = -8 ;
   obj.rotation.x = Math.PI/5 ;
   obj.rotation.y = Math.PI/5 ;
   scene.add(obj) ;
// var light = new THREE.DirectionalLight(0xffffff, 1.5) ;
// light.position.set(0, 0, 1) ;
// scene.add(light) ;
   run() ;
}
function setup() {
   textinput = document.getElementById('desc') ;
   checkchange() ;
}
</script>
</head>
<body onload="setup();">
<table><tr><td valign="top"><canvas id="webglcanvas" width=600 height=600>
</canvas></td>
<td valign="top">Desc <input type=text id=desc value="c f 0.3333333333">
</input><br>
<div id=data></div>
</td></tr></table>
</body></html>
